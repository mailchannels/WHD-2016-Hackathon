<?php

/**
 * Receives and processes input.
 *
 * @author  Constantin Romankiewicz <constantin@zweiiconkram.de>
 * @since   1.0
 */
class Modules_Harvard_Receiver
{
    /**
     * Processes data from a JSON file generated by Mailchannels.
     * Disables reportedly spamming email accounts.
     *
     * @param   array  $data  The decoded data.
     *
     * @return void
     */
    public function processJson($data)
    {
        pm_Log::debug(print_r($data, true));

        $actionConfig = new Modules_Harvard_ActionConfig;
        if (empty($actionConfig)) {
            return;
        }

        if (!(isset($data['envelope_sender']) && isset($data['condition_name']))) {
            return Modules_Harvard_Helper::error('Invalid request.', 400);
        }

        $event = $data['condition_name'];
        $sender = $data['envelope_sender'];

        if (preg_match('/(.*)\@(.*)/i', $data['envelope_sender'], $matches)) {
            $username = $matches[1];
            $domain = $matches[2];
        }

        $mailSettings = new Modules_Harvard_MailSettings();

        foreach ($actionConfig as $item) {
            if ($item->event == $event || $item->event == '*') {

                pm_Log::debug("condition: $item->condition_name, domain: $domain");

                var_dump($mailSettings->disableMailDomain($domain));
            }
        }
    }
}
